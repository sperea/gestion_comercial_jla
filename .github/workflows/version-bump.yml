name: ğŸ“¦ Versionado AutomÃ¡tico Frontend

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  version-bump:
    name: ğŸš€ Versionado y Release AutomÃ¡tico
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.semver.outputs.version }}
      previous_version: ${{ steps.semver.outputs.previous_version }}
      has_changes: ${{ steps.semver.outputs.version != steps.semver.outputs.previous_version }}
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ·ï¸ Obtener Ãºltima versiÃ³n
        id: get-version
        run: |
          if [ -f "VERSION.txt" ]; then
            CURRENT_VERSION=$(cat VERSION.txt)
            echo "current_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ VersiÃ³n actual: ${CURRENT_VERSION}"
          else
            echo "current_version=v0.0.0" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ No existe VERSION.txt, iniciando en v0.0.0"
          fi

      - name: ğŸ§® Calcular nueva versiÃ³n
        id: semver
        uses: ietf-tools/semver-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
          fromTag: ${{ steps.get-version.outputs.current_version }}

      - name: ğŸ“Š Mostrar informaciÃ³n de versiÃ³n
        run: |
          echo "ğŸ” AnÃ¡lisis de versionado:"
          echo "  ğŸ“Œ VersiÃ³n anterior: ${{ steps.semver.outputs.previous_version }}"
          echo "  ğŸ†• Nueva versiÃ³n: ${{ steps.semver.outputs.version }}"
          echo "  ğŸ“ˆ Tipo de cambio: ${{ steps.semver.outputs.bump }}"
          echo "  ğŸ’­ Commits analizados: ${{ steps.semver.outputs.commits }}"

      - name: ğŸ“ Actualizar VERSION.txt
        if: steps.semver.outputs.version != steps.semver.outputs.previous_version
        run: |
          echo "${{ steps.semver.outputs.version }}" > VERSION.txt
          echo "âœ… VERSION.txt actualizado a ${{ steps.semver.outputs.version }}"

      - name: ğŸ“¦ Actualizar package.json
        if: steps.semver.outputs.version != steps.semver.outputs.previous_version
        run: |
          # Remover la 'v' del inicio para package.json
          VERSION_NUMBER=$(echo "${{ steps.semver.outputs.version }}" | sed 's/^v//')
          
          # Actualizar version en package.json usando jq si estÃ¡ disponible
          if command -v jq &> /dev/null; then
            jq ".version = \"${VERSION_NUMBER}\"" package.json > package.json.tmp
            mv package.json.tmp package.json
          else
            # Fallback usando sed si jq no estÃ¡ disponible
            sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"${VERSION_NUMBER}\"/" package.json
          fi
          
          echo "âœ… package.json actualizado a ${VERSION_NUMBER}"
          
          # Mostrar los cambios
          echo "ğŸ“‹ Cambios en package.json:"
          head -10 package.json | grep -A5 -B5 "version"

      - name: ğŸ”„ Commit cambios de versiÃ³n
        if: steps.semver.outputs.version != steps.semver.outputs.previous_version
        run: |
          git add VERSION.txt package.json
          git commit -m "chore(release): bump version to ${{ steps.semver.outputs.version }}

          ğŸ“¦ Automated version bump:
          - Previous: ${{ steps.semver.outputs.previous_version }}
          - Current: ${{ steps.semver.outputs.version }}
          - Type: ${{ steps.semver.outputs.bump }}
          
          [skip ci]"
          
          echo "âœ… Cambios de versiÃ³n committeados"

      - name: ğŸ·ï¸ Crear Tag de Git
        if: steps.semver.outputs.version != steps.semver.outputs.previous_version
        run: |
          git tag -a "${{ steps.semver.outputs.version }}" -m "ğŸš€ Release ${{ steps.semver.outputs.version }}

          ğŸ“‹ Frontend JLA Colaboradores
          ğŸ”– Version: ${{ steps.semver.outputs.version }}
          ğŸ“… Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          ğŸ”„ Type: ${{ steps.semver.outputs.bump }}
          
          ğŸŒŸ Features:
          - Next.js 15.5.4 with TypeScript
          - JWT Authentication with HTTP-Only cookies
          - Profile management with image upload
          - Corporate branding integration
          - Responsive design with Tailwind CSS"
          
          echo "âœ… Tag ${{ steps.semver.outputs.version }} creado"

      - name: ğŸ“¤ Push cambios y tags
        if: steps.semver.outputs.version != steps.semver.outputs.previous_version
        run: |
          git push origin main
          git push origin "${{ steps.semver.outputs.version }}"
          echo "âœ… Cambios y tags pusheados al repositorio"

      - name: ğŸ“‹ Generar Changelog
        if: steps.semver.outputs.version != steps.semver.outputs.previous_version
        id: changelog
        run: |
          echo "Generating changelog for ${{ steps.semver.outputs.version }}"
          
          # Crear changelog bÃ¡sico
          cat << EOF > RELEASE_NOTES.md
          # ğŸš€ Release ${{ steps.semver.outputs.version }}
          
          ## ğŸ“… InformaciÃ³n de Release
          - **VersiÃ³n**: ${{ steps.semver.outputs.version }}
          - **Fecha**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Tipo**: ${{ steps.semver.outputs.bump }}
          - **Branch**: main
          
          ## ğŸ“‹ Commits en este Release
          
          EOF
          
          # Obtener commits desde el Ãºltimo tag
          if [ "${{ steps.semver.outputs.previous_version }}" != "" ]; then
            echo "Obteniendo commits desde ${{ steps.semver.outputs.previous_version }}"
            git log --pretty=format:"- %s (%h)" ${{ steps.semver.outputs.previous_version }}..HEAD >> RELEASE_NOTES.md
          else
            echo "Primera release, obteniendo todos los commits"
            git log --pretty=format:"- %s (%h)" >> RELEASE_NOTES.md
            
          fi
          
          echo "" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ğŸŒŸ CaracterÃ­sticas del Frontend" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "- **Framework**: Next.js 15.5.4" >> RELEASE_NOTES.md
          echo "- **Lenguaje**: TypeScript" >> RELEASE_NOTES.md
          echo "- **Estilos**: Tailwind CSS" >> RELEASE_NOTES.md
          echo "- **AutenticaciÃ³n**: JWT con cookies HTTP-Only" >> RELEASE_NOTES.md
          echo "- **Estado**: React Context API" >> RELEASE_NOTES.md
          echo "- **Notificaciones**: React Hot Toast" >> RELEASE_NOTES.md
          echo "- **ImÃ¡genes**: Sistema completo de perfil" >> RELEASE_NOTES.md
          
          # Mostrar el changelog generado
          echo "ğŸ“‹ Changelog generado:"
          cat RELEASE_NOTES.md

      - name: ğŸ‰ Crear GitHub Release
        if: steps.semver.outputs.version != steps.semver.outputs.previous_version
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.semver.outputs.version }}
          release_name: ğŸš€ Frontend JLA v${{ steps.semver.outputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false

  build-docker:
    name: ğŸ³ Construir Imagen Docker
    runs-on: ubuntu-latest
    needs: version-bump
    if: needs.version-bump.outputs.has_changes == 'true'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Instalar dependencias
        run: npm ci

      - name: ğŸ—ï¸ Build aplicaciÃ³n
        run: npm run build

      - name: ğŸ·ï¸ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login a GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ Extraer metadatos
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/colaboradores-frontend
          tags: |
            type=semver,pattern={{version}},value=${{ needs.version-bump.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.version-bump.outputs.version }}
            type=raw,value=latest

      - name: ğŸ³ Build y Push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.version-bump.outputs.version }}
            BUILD_DATE=${{ steps.meta.outputs.date }}

      - name: âœ… Resumen Docker Build
        run: |
          echo "ğŸ³ Docker Build Completado:"
          echo "  ğŸ“¦ Imagen: ghcr.io/${{ github.repository_owner }}/colaboradores-frontend"
          echo "  ğŸ·ï¸ Tags: ${{ steps.meta.outputs.tags }}"
          echo "  ğŸ“‹ VersiÃ³n: ${{ needs.version-bump.outputs.version }}"

  notify-completion:
    name: ğŸ“¢ NotificaciÃ³n de Completado
    runs-on: ubuntu-latest
    needs: [version-bump, build-docker]
    if: always() && needs.version-bump.outputs.has_changes == 'true'
    
    steps:
      - name: ğŸ‰ Resumen Final
        run: |
          echo "ğŸš€ VERSIONADO AUTOMÃTICO COMPLETADO"
          echo "=================================="
          echo ""
          echo "ğŸ“‹ Detalles del Release:"
          echo "  ğŸ”– Nueva VersiÃ³n: ${{ needs.version-bump.outputs.version }}"
          echo "  ğŸ“… Fecha: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "  ğŸŒ Repository: ${{ github.repository }}"
          echo "  ğŸ¯ Branch: ${{ github.ref_name }}"
          echo ""
          echo "âœ… Tareas Completadas:"
          echo "  - âœ… Versionado automÃ¡tico"
          echo "  - âœ… ActualizaciÃ³n de archivos"
          echo "  - âœ… Git tagging"
          echo "  - âœ… GitHub Release"
          if [ "${{ needs.build-docker.result }}" == "success" ]; then
            echo "  - âœ… Docker build y push"
          else
            echo "  - âŒ Docker build fallÃ³"
          fi
          echo ""
          echo "ğŸ”— Enlaces:"
          echo "  ğŸ“¦ Releases: https://github.com/${{ github.repository }}/releases"
          echo "  ğŸ³ Docker: https://github.com/${{ github.repository }}/pkgs/container/colaboradores-frontend"
          echo "  âš¡ Actions: https://github.com/${{ github.repository }}/actions"