name: ğŸ“¦ Versionado AutomÃ¡tico Frontend

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  version-bump:
    name: ğŸš€ Versionado y Release AutomÃ¡tico
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: ğŸ·ï¸ Obtener versiÃ³n actual y calcular nueva
        id: version
        run: |
          # Obtener la Ãºltima versiÃ³n
          CURRENT_VERSION=$(cat VERSION.txt 2>/dev/null || echo "v0.1.0")
          echo "current_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
          
          # Obtener el Ãºltimo tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.1.0")
          echo "last_tag=${LAST_TAG}" >> $GITHUB_OUTPUT
          
          # Analizar commits desde el Ãºltimo tag
          COMMITS=$(git log ${LAST_TAG}..HEAD --oneline)
          echo "commits_since_tag=$(echo "$COMMITS" | wc -l)" >> $GITHUB_OUTPUT
          
          # Determinar el tipo de bump basado en commits convencionales
          BUMP_TYPE="patch"
          
          if echo "$COMMITS" | grep -q "BREAKING CHANGE\|feat!:"; then
            BUMP_TYPE="major"
          elif echo "$COMMITS" | grep -q "^feat:"; then
            BUMP_TYPE="minor"
          elif echo "$COMMITS" | grep -q "^fix:"; then
            BUMP_TYPE="patch"
          else
            # Si no hay commits convencionales relevantes, no hacer bump
            if [ $(echo "$COMMITS" | wc -l) -eq 0 ]; then
              echo "skip_version=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          echo "bump_type=${BUMP_TYPE}" >> $GITHUB_OUTPUT
          
          # Calcular nueva versiÃ³n
          VERSION_PARTS=(${CURRENT_VERSION//v})
          VERSION_PARTS=(${VERSION_PARTS//./ })
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          case $BUMP_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ InformaciÃ³n de versionado:"
          echo "  ğŸ“Œ VersiÃ³n actual: ${CURRENT_VERSION}"
          echo "  ğŸ†• Nueva versiÃ³n: ${NEW_VERSION}"
          echo "  ğŸ“ˆ Tipo de cambio: ${BUMP_TYPE}"
          echo "  ğŸ’­ Commits desde Ãºltimo tag: $(echo "$COMMITS" | wc -l)"

      - name: ğŸ“ Actualizar VERSION.txt
        if: steps.version.outputs.skip_version != 'true'
        run: |
          echo "${{ steps.version.outputs.new_version }}" > VERSION.txt
          echo "âœ… VERSION.txt actualizado a ${{ steps.version.outputs.new_version }}"

      - name: ğŸ“¦ Actualizar package.json
        if: steps.version.outputs.skip_version != 'true'
        run: |
          VERSION_NUMBER=$(echo "${{ steps.version.outputs.new_version }}" | sed 's/^v//')
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"${VERSION_NUMBER}\"/" package.json
          echo "âœ… package.json actualizado a ${VERSION_NUMBER}"

      - name: ğŸ”„ Commit cambios de versiÃ³n
        if: steps.version.outputs.skip_version != 'true'
        run: |
          git add VERSION.txt package.json
          git commit -m "chore(release): bump version to ${{ steps.version.outputs.new_version }}

          ğŸ“¦ Automated version bump
          - New version: ${{ steps.version.outputs.new_version }}
          - Type: ${{ steps.version.outputs.bump_type }}
          
          [skip ci]"
          
          echo "âœ… Cambios de versiÃ³n committeados"

      - name: ğŸ·ï¸ Crear Tag de Git
        if: steps.version.outputs.skip_version != 'true'
        run: |
          git tag -a "${{ steps.version.outputs.new_version }}" -m "ğŸš€ Release ${{ steps.version.outputs.new_version }}

          ğŸ“‹ Frontend JLA Colaboradores
          ğŸ”– Version: ${{ steps.version.outputs.new_version }}
          ğŸ“… Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          ğŸ”„ Type: ${{ steps.version.outputs.bump_type }}
          
          ğŸŒŸ CaracterÃ­sticas:
          - Next.js 15.5.4 with TypeScript
          - JWT Authentication with HTTP-Only cookies
          - Profile management with image upload
          - Corporate branding integration
          - Responsive design with Tailwind CSS
          - Automatic versioning system"
          
          echo "âœ… Tag ${{ steps.version.outputs.new_version }} creado"

      - name: ğŸ“¤ Push cambios y tags
        if: steps.version.outputs.skip_version != 'true'
        run: |
          git push origin main
          git push origin "${{ steps.version.outputs.new_version }}"
          echo "âœ… Cambios y tags pusheados al repositorio"

      - name: ğŸ“‹ Generar Changelog
        if: steps.version.outputs.skip_version != 'true'
        run: |
          echo "Generando changelog para ${{ steps.version.outputs.new_version }}"
          
          cat << EOF > RELEASE_NOTES.md
          # ğŸš€ Release ${{ steps.version.outputs.new_version }}
          
          ## ğŸ“… InformaciÃ³n de Release
          - **VersiÃ³n**: ${{ steps.version.outputs.new_version }}
          - **Fecha**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Tipo**: ${{ steps.version.outputs.bump_type }}
          - **Branch**: main
          
          ## ğŸ“‹ Commits en este Release
          
          EOF
          
          # Obtener commits desde el Ãºltimo tag
          git log ${{ steps.version.outputs.last_tag }}..HEAD --pretty=format:"- %s (%h)" >> RELEASE_NOTES.md
          
          cat << EOF >> RELEASE_NOTES.md
          
          ## ğŸŒŸ CaracterÃ­sticas del Frontend
          
          - **Framework**: Next.js 15.5.4
          - **Lenguaje**: TypeScript
          - **Estilos**: Tailwind CSS
          - **AutenticaciÃ³n**: JWT con cookies HTTP-Only
          - **Estado**: React Context API
          - **Notificaciones**: React Hot Toast
          - **ImÃ¡genes**: Sistema completo de perfil
          - **Versionado**: Sistema automÃ¡tico con Conventional Commits
          EOF
          
          echo "ğŸ“‹ Changelog generado:"
          cat RELEASE_NOTES.md

      - name: ğŸ‰ Crear GitHub Release
        if: steps.version.outputs.skip_version != 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.new_version }}
          name: ğŸš€ Frontend JLA ${{ steps.version.outputs.new_version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Resumen Final
        if: steps.version.outputs.skip_version != 'true'
        run: |
          echo "ğŸš€ VERSIONADO AUTOMÃTICO COMPLETADO"
          echo "=================================="
          echo ""
          echo "ğŸ“‹ Detalles del Release:"
          echo "  ğŸ”– Nueva VersiÃ³n: ${{ steps.version.outputs.new_version }}"
          echo "  ğŸ“… Fecha: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "  ğŸŒ Repository: ${{ github.repository }}"
          echo "  ğŸ¯ Branch: ${{ github.ref_name }}"
          echo ""
          echo "ğŸ”— Enlaces:"
          echo "  ğŸ“¦ Releases: https://github.com/${{ github.repository }}/releases"
          echo "  âš¡ Actions: https://github.com/${{ github.repository }}/actions"

      - name: â„¹ï¸ Sin cambios de versiÃ³n
        if: steps.version.outputs.skip_version == 'true'
        run: |
          echo "â„¹ï¸ No se requiere cambio de versiÃ³n"
          echo "  ğŸ“Œ VersiÃ³n actual: ${{ steps.version.outputs.current_version }}"
          echo "  ğŸ“‹ No hay commits convencionales relevantes desde el Ãºltimo tag"